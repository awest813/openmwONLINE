<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OpenMW - Morrowind in the Browser</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: #1a1a2e;
      color: #e0e0e0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      overflow: hidden;
      height: 100vh;
    }
    #loading-overlay {
      position: fixed; inset: 0;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      background: #1a1a2e;
      z-index: 100;
      transition: opacity 0.5s;
    }
    #loading-overlay.hidden { opacity: 0; pointer-events: none; }
    #loading-overlay h1 {
      font-size: 2.5rem; margin-bottom: 1rem;
      color: #c8a86e;
    }
    #loading-overlay p { color: #999; margin-bottom: 2rem; }
    #progress-container {
      width: 400px; max-width: 80vw;
      background: #2a2a3e; border-radius: 8px;
      overflow: hidden; margin-bottom: 1.5rem;
    }
    #progress-bar {
      height: 6px; width: 0%;
      background: linear-gradient(90deg, #c8a86e, #e8c88e);
      transition: width 0.3s;
    }
    #status { color: #888; font-size: 0.9rem; }
    #data-picker-section {
      text-align: center; margin-top: 2rem;
      display: none;
    }
    #data-picker-section.visible { display: block; }
    #pick-data-btn {
      padding: 12px 32px; font-size: 1rem;
      background: #c8a86e; color: #1a1a2e;
      border: none; border-radius: 6px;
      cursor: pointer; font-weight: 600;
      transition: background 0.2s;
    }
    #pick-data-btn:hover { background: #e8c88e; }
    #pick-data-btn:disabled { background: #666; cursor: wait; }
    #data-hint {
      margin-top: 0.8rem; color: #888;
      font-size: 0.85rem; max-width: 500px;
    }
    #upload-progress {
      display: none; margin-top: 1.2rem;
      text-align: center;
    }
    #upload-progress.visible { display: block; }
    #upload-stats {
      color: #c8a86e; font-size: 0.95rem;
      margin-bottom: 0.5rem;
    }
    #upload-bar-container {
      width: 400px; max-width: 80vw;
      background: #2a2a3e; border-radius: 8px;
      overflow: hidden; margin: 0 auto;
    }
    #upload-bar {
      height: 6px; width: 0%;
      background: linear-gradient(90deg, #6bcb77, #4caf50);
      transition: width 0.15s;
    }
    #upload-detail {
      color: #666; font-size: 0.8rem;
      margin-top: 0.4rem;
    }
    #canvas-container {
      width: 100vw; height: 100vh;
      display: none;
    }
    #canvas-container.visible { display: block; }
    canvas#canvas {
      width: 100%; height: 100%;
      display: block;
    }
    #console-output {
      position: fixed; bottom: 0; left: 0; right: 0;
      max-height: 200px; overflow-y: auto;
      background: rgba(0,0,0,0.85);
      padding: 8px 12px;
      font-family: "Fira Code", "Consolas", monospace;
      font-size: 0.75rem;
      color: #aaa;
      display: none; z-index: 50;
    }
    #console-output.visible { display: block; }
    .log-error { color: #ff6b6b; }
    .log-warn { color: #ffd93d; }
    .log-info { color: #6bcb77; }
  </style>
</head>
<body>
  <div id="loading-overlay">
    <h1>OpenMW</h1>
    <p>Morrowind in the Browser</p>
    <div id="progress-container" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
      <div id="progress-bar"></div>
    </div>
    <div id="status">Initializing engine...</div>
    <div id="data-picker-section">
      <button id="pick-data-btn" onclick="pickDataDirectory()">
        Select Morrowind Data Folder
      </button>
      <p id="data-hint">
        Select the "Data Files" folder from your Morrowind installation.
        This typically contains files like Morrowind.esm, Morrowind.bsa, etc.
      </p>
      <div id="upload-progress">
        <div id="upload-stats"></div>
        <div id="upload-bar-container" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
          <div id="upload-bar"></div>
        </div>
        <div id="upload-detail"></div>
      </div>
    </div>
  </div>

  <div id="canvas-container">
    <canvas id="canvas" oncontextmenu="event.preventDefault()" tabindex="-1"></canvas>
  </div>

  <div id="console-output"></div>

  <script>
    var statusEl = document.getElementById('status');
    var progressBar = document.getElementById('progress-bar');
    var loadingOverlay = document.getElementById('loading-overlay');
    var canvasContainer = document.getElementById('canvas-container');
    var dataPickerSection = document.getElementById('data-picker-section');
    var consoleOutput = document.getElementById('console-output');

    function setStatus(text) {
      statusEl.textContent = text;
    }

    function setProgress(pct) {
      var clamped = Math.min(100, Math.max(0, pct));
      progressBar.style.width = clamped + '%';
      progressBar.parentElement.setAttribute('aria-valuenow', Math.round(clamped));
    }

    function showCanvas() {
      loadingOverlay.classList.add('hidden');
      canvasContainer.classList.add('visible');
      document.getElementById('canvas').focus();
    }

    var MAX_CONSOLE_LINES = 500;

    function logToConsole(msg, level) {
      var line = document.createElement('div');
      line.textContent = msg;
      if (level === 'error') line.className = 'log-error';
      else if (level === 'warn') line.className = 'log-warn';
      else if (level === 'info') line.className = 'log-info';
      consoleOutput.appendChild(line);
      while (consoleOutput.childElementCount > MAX_CONSOLE_LINES)
        consoleOutput.removeChild(consoleOutput.firstChild);
      consoleOutput.scrollTop = consoleOutput.scrollHeight;
    }

    function toggleConsole() {
      consoleOutput.classList.toggle('visible');
    }

    document.addEventListener('keydown', function(e) {
      if (e.key === '`' || e.key === '~') {
        e.preventDefault();
        toggleConsole();
      }
    });

    var uploadProgress = document.getElementById('upload-progress');
    var uploadStats = document.getElementById('upload-stats');
    var uploadBar = document.getElementById('upload-bar');
    var uploadDetail = document.getElementById('upload-detail');

    function formatBytes(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
      return (bytes / (1024 * 1024 * 1024)).toFixed(2) + ' GB';
    }

    async function pickDataDirectory() {
      if (typeof globalThis.__openmwPickDataDirectory === 'function') {
        var btn = document.getElementById('pick-data-btn');
        btn.disabled = true;
        btn.textContent = 'Uploading files...';
        setStatus('Loading game data...');

        globalThis.__openmwOnUploadPhase = function(phase) {
          if (phase === 'scanning') {
            setStatus('Scanning directory...');
            uploadProgress.classList.add('visible');
            uploadStats.textContent = 'Counting files...';
            uploadBar.style.width = '0%';
          } else if (phase === 'uploading') {
            setStatus('Uploading game data...');
          }
        };

        globalThis.__openmwOnUploadProgress = function(files, totalFiles, bytes, totalBytes) {
          var pct = totalBytes > 0 ? (bytes / totalBytes) * 100 : 0;
          uploadBar.style.width = pct.toFixed(1) + '%';
          uploadBar.parentElement.setAttribute('aria-valuenow', Math.round(pct));
          uploadStats.textContent = files + ' / ' + totalFiles + ' files';
          uploadDetail.textContent = formatBytes(bytes) + ' / ' + formatBytes(totalBytes) + ' (' + pct.toFixed(0) + '%)';
        };

        try {
          await globalThis.__openmwPickDataDirectory();
          setStatus('Game data loaded successfully!');
          uploadProgress.classList.remove('visible');
          dataPickerSection.style.display = 'none';
        } catch (e) {
          setStatus('Failed to load game data: ' + e.message);
          uploadProgress.classList.remove('visible');
          btn.disabled = false;
          btn.textContent = 'Select Morrowind Data Folder';
        }
      } else {
        setStatus('Engine not ready yet, please wait...');
      }
    }

    var Module = {
      canvas: (function() { return document.getElementById('canvas'); })(),
      print: function(text) {
        console.log(text);
        logToConsole(text, 'info');
      },
      printErr: function(text) {
        console.error(text);
        logToConsole(text, 'error');
      },
      setStatus: function(text) {
        if (text) {
          var match = text.match(/([^(]+)\((\d+(\.\d+)?)\/(\d+)\)/);
          if (match) {
            var pct = (parseFloat(match[2]) / parseFloat(match[4])) * 100;
            setProgress(pct);
            setStatus(match[1].trim());
          } else {
            setStatus(text);
          }
        }
      },
      onRuntimeInitialized: function() {
        setStatus('Engine initialized');
        setProgress(100);
        if (typeof window.showDirectoryPicker === 'function') {
          dataPickerSection.classList.add('visible');
          setStatus('Ready - select your Morrowind data folder to begin');
        } else {
          setStatus('File System Access API not available in this browser');
          logToConsole('Your browser does not support the File System Access API.', 'warn');
          logToConsole('Try Chrome, Edge, or another Chromium-based browser.', 'warn');
        }
      },
    };
  </script>
  {{{ SCRIPT }}}
</body>
</html>
